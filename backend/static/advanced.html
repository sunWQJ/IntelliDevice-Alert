<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>æ™ºæ¢°é¢„è­¦ Â· é«˜çº§åŠŸèƒ½</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto;max-width:1200px;margin:20px auto;padding:0 16px}
    h1{font-size:24px;margin:12px 0;color:#2c3e50}
    h2{font-size:18px;margin:15px 0;color:#34495e}
    section{border:1px solid #e5e5e5;border-radius:8px;padding:20px;margin:15px 0;background:#f8f9fa}
    label{display:block;margin:8px 0;font-weight:bold}
    input,textarea,select,button{font-size:14px;padding:8px;border-radius:4px;border:1px solid #ccc}
    textarea{width:100%;min-height:120px;resize:vertical}
    pre{background:#f7f7f8;padding:15px;overflow:auto;border-radius:6px;font-size:12px;max-height:300px}
    .row{display:flex;gap:15px;flex-wrap:wrap;align-items:center}
    .row > *{flex:1;min-width:200px}
    .nav-bar{background:#2c3e50;color:white;padding:15px;border-radius:8px;margin-bottom:20px;display:flex;justify-content:space-between;align-items:center}
    .nav-bar a{color:white;text-decoration:none;padding:8px 16px;border-radius:4px;background:#34495e;transition:background 0.3s}
    .nav-bar a:hover{background:#4a5f7a}
    .warning-box{background:#fff3cd;padding:15px;border-radius:8px;border-left:4px solid #ffc107;margin:15px 0}
    .success-box{background:#d4edda;padding:15px;border-radius:8px;border-left:4px solid #28a745;margin:15px 0}
    .danger-box{background:#f8d7da;padding:15px;border-radius:8px;border-left:4px solid #dc3545;margin:15px 0}
    .grid-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px}
    .card{background:white;border:1px solid #ddd;border-radius:8px;padding:15px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
    .btn-primary{background:#007bff;color:white;border:none;padding:10px 20px;border-radius:5px;cursor:pointer;font-size:14px}
    .btn-primary:hover{background:#0056b3}
    .btn-success{background:#28a745;color:white;border:none;padding:10px 20px;border-radius:5px;cursor:pointer;font-size:14px}
    .btn-success:hover{background:#1e7e34}
    .btn-warning{background:#ffc107;color:black;border:none;padding:10px 20px;border-radius:5px;cursor:pointer;font-size:14px}
    .btn-warning:hover{background:#e0a800}
    .btn-danger{background:#dc3545;color:white;border:none;padding:10px 20px;border-radius:5px;cursor:pointer;font-size:14px}
    .btn-danger:hover{background:#c82333}
  </style>
</head>
<body>
  <div class="nav-bar">
    <div>
      <h1 style="margin:0;color:white;">æ™ºæ¢°é¢„è­¦ Â· é«˜çº§åŠŸèƒ½</h1>
    </div>
    <div>
      <a href="/">ğŸ  è¿”å›ä¸»é¡µ</a>
      <a href="#" onclick="location.reload()">ğŸ”„ åˆ·æ–°</a>
    </div>
  </div>

  <div class="warning-box">
    <strong>âš ï¸ é«˜çº§åŠŸèƒ½è¯´æ˜ï¼š</strong> æœ¬é¡µé¢åŒ…å«ç³»ç»Ÿçš„é«˜çº§åŠŸèƒ½å’Œé…ç½®é€‰é¡¹ï¼Œå»ºè®®ä»…ç”±ç®¡ç†å‘˜æˆ–é«˜çº§ç”¨æˆ·ä½¿ç”¨ã€‚ä¸å½“æ“ä½œå¯èƒ½å½±å“ç³»ç»Ÿæ•°æ®è´¨é‡ã€‚
  </div>

  <div class="grid-container">
    <!-- ç»“æ„åŒ–åˆ†æä¸ä¼˜åŒ–å·¥ä½œæµ -->
    <div class="card" style="grid-column: 1 / -1;">
      <h2>ğŸ”„ ç»“æ„åŒ–åˆ†æä¸ä¼˜åŒ–å·¥ä½œæµ</h2>
      <div class="success-box">
        <strong>å·¥ä½œæµç¨‹ï¼š</strong> ç»“æ„åŒ–åˆ†æ â†’ åŒ¹é…éªŒè¯ â†’ æ–‡æœ¬ä¼˜åŒ–ï¼ˆå¦‚éœ€è¦ï¼‰ â†’ çŸ¥è¯†å›¾è°±å½•å…¥
      </div>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
        <!-- å·¦ä¾§ï¼šè¾“å…¥åŒºåŸŸ -->
        <div>
          <h3>ğŸ“‹ è¾“å…¥åŒ»ç–—äº‹ä»¶æè¿°</h3>
          <label>åŸå§‹äº‹ä»¶æè¿°ï¼š</label>
          <textarea id="workflow_input" placeholder="è¯·è¾“å…¥éœ€è¦åˆ†æçš„åŒ»ç–—äº‹ä»¶æè¿°ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è¿›è¡Œç»“æ„åŒ–åˆ†æå’Œæœ¯è¯­åŒ¹é…" style="height: 120px;">è®¾å¤‡å±å¹•æ— æ˜¾ç¤ºï¼Œæ‚£è€…ç›‘æŠ¤ä¸­æ–­ï¼Œç«‹å³æ›´æ¢è®¾å¤‡å¹¶è½¬å…¥ICUè§‚å¯Ÿã€‚</textarea>
          
          <div class="row" style="margin-top: 15px;">
            <select id="workflow_provider" style="flex: 1;">
              <option value="openai">OpenAI</option>
              <option value="gemini">Gemini</option>
            </select>
            <button id="btnWorkflowAnalyze" class="btn-primary">ğŸ” å¼€å§‹ç»“æ„åŒ–åˆ†æ</button>
          </div>
        </div>
        
        <!-- å³ä¾§ï¼šç»“æœåŒºåŸŸ -->
        <div>
          <h3>ğŸ“Š åˆ†æç»“æœ</h3>
          <div id="workflow_result" style="background: #f8f9fa; padding: 15px; border-radius: 5px; min-height: 120px; border: 1px solid #ddd;">
            <p style="color: #666; text-align: center; margin: 20px 0;">ç­‰å¾…åˆ†æç»“æœ...</p>
          </div>
          
          <div class="row" style="margin-top: 15px;">
            <button id="btnWorkflowOptimize" class="btn-warning" style="display: none;">âœ¨ ä¼˜åŒ–æ–‡æœ¬é‡æ–°åˆ†æ</button>
            <button id="btnWorkflowStore" class="btn-success" style="display: none;">ğŸ’¾ ç¡®è®¤å¹¶å½•å…¥çŸ¥è¯†å›¾è°±</button>
          </div>
        </div>
      </div>
      
      <pre id="outWorkflow" style="margin-top: 20px;"></pre>
    </div>

    <!-- æœ¯è¯­åº“ç®¡ç† -->
    <div class="card">
      <h2>ğŸ“š æœ¯è¯­åº“ç®¡ç†</h2>
      <div class="warning-box">
        <strong>é‡è¦ï¼š</strong> ç®¡ç†çŸ¥è¯†å›¾è°±ä¸­çš„æ ‡å‡†æœ¯è¯­ï¼Œç¡®ä¿åŒ¹é…å‡†ç¡®æ€§ã€‚
      </div>
      
      <label>æœ¯è¯­ç±»åˆ«é€‰æ‹©ï¼š</label>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 10px 0;">
        <label><input type="checkbox" class="cat" value="A" checked> Aï¼ˆè®¾å¤‡é—®é¢˜ï¼‰</label>
        <label><input type="checkbox" class="cat" value="E" checked> Eï¼ˆä¸´åºŠç—‡çŠ¶/ç—…ç—‡ï¼‰</label>
        <label><input type="checkbox" class="cat" value="F" checked> Fï¼ˆå¥åº·å½±å“ï¼‰</label>
        <label><input type="checkbox" class="cat" value="G"> Gï¼ˆå™¨æ¢°ç»„ä»¶ï¼‰</label>
        <label><input type="checkbox" class="cat" value="C"> Cï¼ˆè°ƒæŸ¥ç»“æœï¼‰</label>
        <label><input type="checkbox" class="cat" value="D"> Dï¼ˆè°ƒæŸ¥ç»“è®ºï¼‰</label>
      </div>
      
      <div class="row" style="margin-top: 15px;">
        <label style="flex: 1;"><input type="checkbox" id="include_syn" checked> åŒ…å«åŒä¹‰è¯</label>
        <button id="btnImportTerms" class="btn-danger">ğŸ”„ æ›´æ–°æœ¯è¯­åº“</button>
      </div>
      <pre id="outImportTerms"></pre>
    </div>

    <!-- æŠ¥å‘Šæ•°æ®ç®¡ç† -->
    <div class="card">
      <h2>ğŸ“Š æŠ¥å‘Šæ•°æ®ç®¡ç†</h2>
      <div class="row">
        <button id="btnExportReports" class="btn-primary">ğŸ“¥ å¯¼å‡ºæŠ¥å‘Šæ•°æ®</button>
        <button id="btnImportExcel" class="btn-success">ğŸ“¤ Excelå¯¼å…¥</button>
        <input type="file" id="excel_file" accept=".xlsx" style="display: none;">
      </div>
      
      <div style="margin-top: 15px;">
        <label>æ•°æ®æ“ä½œï¼š</label>
        <div class="row">
          <button id="btnClearData" class="btn-warning">ğŸ—‘ï¸ æ¸…ç©ºæµ‹è¯•æ•°æ®</button>
          <button id="btnLoadSample" class="btn-info">ğŸ“‹ åŠ è½½ç¤ºä¾‹æ•°æ®</button>
        </div>
      </div>
      <pre id="outDataManagement"></pre>
    </div>

    <!-- ç³»ç»Ÿé…ç½® -->
    <div class="card">
      <h2>âš™ï¸ ç³»ç»Ÿé…ç½®</h2>
      <div class="warning-box">
        <strong>å®‰å…¨æç¤ºï¼š</strong> APIé…ç½®ä¿¡æ¯å°†å®‰å…¨å­˜å‚¨ã€‚
      </div>
      
      <label>LLMæœåŠ¡é…ç½®ï¼š</label>
      <div class="row">
        <select id="cfg_provider" style="flex: 1;">
          <option value="openai">OpenAI</option>
          <option value="gemini">Gemini</option>
        </select>
        <input id="cfg_apikey" placeholder="APIå¯†é’¥" style="flex: 2;">
        <input id="cfg_model" placeholder="æ¨¡å‹ï¼ˆå¯é€‰ï¼‰" style="flex: 1;">
      </div>
      
      <div class="row" style="margin-top: 10px;">
        <button id="btnSaveCfg" class="btn-primary">ğŸ’¾ ä¿å­˜é…ç½®</button>
        <button id="btnTestConnection" class="btn-info">ğŸ”— æµ‹è¯•è¿æ¥</button>
      </div>
      <pre id="outCfg"></pre>
    </div>
  </div>

  <script>
    async function postJSON(url, body){
      const r = await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
      const t = await r.text();
      try{return JSON.parse(t)}catch{return {raw:t}};
    }

    // å·¥ä½œæµï¼šç»“æ„åŒ–åˆ†æ
    document.getElementById('btnWorkflowAnalyze').onclick = async ()=>{
      const provider = document.getElementById('workflow_provider').value;
      const text = document.getElementById('workflow_input').value;
      const url = '/reports/analyze-structure?use_llm=true';
      const res = await postJSON(url, {provider, event_description: text});
      document.getElementById('workflow_result').textContent = JSON.stringify(res, null, 2);
      const data = res && res.data ? res.data : {};
      window.__WF_LLM_ENTS = data.llm_entities || [];
      window.__WF_LLM_RELS = data.llm_relations || [];
      document.getElementById('btnWorkflowOptimize').style.display = 'inline-block';
      document.getElementById('btnWorkflowStore').style.display = 'inline-block';
    };

    // æ–‡æœ¬ä¼˜åŒ–ï¼ˆLLMé‡æ„ï¼‰
    document.getElementById('btnWorkflowOptimize').onclick = async ()=>{
      const provider = document.getElementById('workflow_provider').value;
      const text = document.getElementById('workflow_input').value;
      const res = await postJSON('/llm/restructure', {provider, event_description: text, action_taken: ''});
      if(res && res.success && res.data){
        if(res.data.event_description) document.getElementById('workflow_input').value = res.data.event_description;
        const again = await postJSON('/reports/analyze-structure?use_llm=true', {provider, event_description: document.getElementById('workflow_input').value});
        document.getElementById('workflow_result').textContent = JSON.stringify(again, null, 2);
        const d = again && again.data ? again.data : {};
        window.__WF_LLM_ENTS = d.llm_entities || [];
        window.__WF_LLM_RELS = d.llm_relations || [];
      }
    };

    // ç¡®è®¤å¹¶å½•å…¥çŸ¥è¯†å›¾è°±
    document.getElementById('btnWorkflowStore').onclick = async ()=>{
      const provider = document.getElementById('workflow_provider').value;
      const text = document.getElementById('workflow_input').value;
      const body = {
        hospital_id: 'H001',
        device_name: 'æœªçŸ¥è®¾å¤‡',
        manufacturer: '',
        model: '',
        lot_sn: '',
        event_datetime: new Date().toISOString(),
        event_description: text,
        injury_severity: 'none',
        action_taken: '',
        llm_entities: window.__WF_LLM_ENTS || [],
        llm_relations: window.__WF_LLM_RELS || []
      };
      const res = await postJSON('/reports/structured-confirm', body);
      document.getElementById('outWorkflow').textContent = JSON.stringify(res, null, 2);
    };

    // Excelå¯¼å…¥ï¼ˆä½¿ç”¨éšè—æ–‡ä»¶æ¡†ï¼‰
    document.getElementById('btnImportExcel').onclick = ()=>{
      document.getElementById('excel_file').click();
    };

    document.getElementById('excel_file').onchange = async ()=>{
      const f = document.getElementById('excel_file').files[0];
      if(!f){ document.getElementById('outDataManagement').textContent = 'æœªé€‰æ‹©æ–‡ä»¶'; return; }
      const fd = new FormData();
      fd.append('file', f);
      const r = await fetch('/reports/upload-excel?auto_threshold=0.6&review_queue=true',{method:'POST', body:fd});
      const t = await r.text();
      try{ document.getElementById('outDataManagement').textContent = JSON.stringify(JSON.parse(t),null,2); }
      catch{ document.getElementById('outDataManagement').textContent = t; }
    };

    // æœ¯è¯­å¯¼å…¥åˆ°Neo4j
    document.getElementById('btnImportTerms').onclick = async ()=>{
      const cats = Array.from(document.querySelectorAll('.cat')).filter(x=>x.checked).map(x=>x.value);
      const include_synonyms = document.getElementById('include_syn').checked;
      const data = await postJSON('/graph/import-terms', {categories: cats, include_synonyms});
      document.getElementById('outImportTerms').textContent = JSON.stringify(data,null,2);
    };

    // LLMé…ç½®
    document.getElementById('btnSaveCfg').onclick = async ()=>{
      const provider = document.getElementById('cfg_provider').value;
      const api_key = document.getElementById('cfg_apikey').value;
      const model = document.getElementById('cfg_model').value;
      if(!api_key){ document.getElementById('outCfg').textContent = 'è¯·è¾“å…¥APIå¯†é’¥'; return; }
      const data = await postJSON('/config/llm', {provider, api_key, model});
      document.getElementById('outCfg').textContent = JSON.stringify(data,null,2);
      document.getElementById('cfg_apikey').value = '';
    };

    window.addEventListener('load', () => { console.log('é«˜çº§åŠŸèƒ½é¡µé¢å·²åŠ è½½å®Œæˆ'); });
  </script>

  <footer style="text-align:center;margin-top:40px;padding:20px;border-top:1px solid #ddd;color:#666;">
    <p>æ™ºæ¢°é¢„è­¦ç³»ç»Ÿ Â· é«˜çº§åŠŸèƒ½é¡µé¢</p>
    <p style="font-size:12px;">å»ºè®®ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„Chromeã€Firefoxæˆ–Edgeæµè§ˆå™¨è·å¾—æœ€ä½³ä½“éªŒ</p>
  </footer>
</body>
</html>