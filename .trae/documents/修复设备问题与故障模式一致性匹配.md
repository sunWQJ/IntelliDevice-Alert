## 根因分析
- 设备问题(DeviceIssue)提取覆盖面广，命中率高；故障模式(FailureMode)依赖术语库A类匹配，覆盖不足或阈值偏高，导致回退到“未知故障模式”。
- 文本经常只描述现象(如“显示异常/漏水/噪音”)，未出现机制词(如“电路故障/传感器失准”)；需要从现象到机制的映射。
- 现有评分仅看单类术语的匹配分，未考虑“设备问题↔故障模式”的一致性。

## 改造目标
- 设备问题与故障模式双向联动：先识别设备问题，再根据映射推导故障模式；或先识别故障模式再回填设备问题。
- 降低“未知故障模式”的比例；当存在高置信度 DeviceIssue 时，尽量产出一致的 FailureMode。

## 实现方案
### 1) 术语与映射增强
- 新增映射文件：`术语库/mappings/device_issue_to_failure_mode.json`
  - 结构：`{"显示屏黑屏":[{"term":"显示模块故障","aliases":["背光故障"]}],"连接管漏水":[{"term":"管路密封失效"}],...}`
  - 允许多对一与别名；维护简便，便于逐步扩充。
- 别名库与正则模式增强：`术语库/*别名*.json` 与 `patterns/failure_mode_patterns.yaml`（可选），覆盖常见中文表达。

### 2) 匹配流程改造（StructureAnalyzer）
- 阶段化：
  1. 识别 DeviceIssue（现有逻辑保留）
  2. 若 DeviceIssue 置信度≥T_issue(默认0.5)，根据映射文件生成 FailureMode 候选，并做 A 类二次匹配(搜索窗口扩大，允许同义词注入)
  3. 若 FailureMode 未命中，尝试用 DeviceIssue 文本+高频机制词组合进行 A 类检索（如“显示异常+模块/传感器/电源”）
  4. 若仍不足，触发 LLM兜底（仅在用户选择或 review 阶段）
- 一致性评分：
  - 最终分 = `max(术语匹配分, 映射一致性分)`；一致性分基于 DeviceIssue→FM 映射命中、词汇重叠、语义相似；权重建议0.3~0.4。
- 回填：
  - 若识别到 FailureMode 且 DeviceIssue 为空，用 FM→Issue逆映射或机制→现象规则回填 DeviceIssue。

### 3) 评分与阈值
- 设备问题初判阈值 T_issue=0.5；故障模式产出阈值 T_fm=0.4；整体 `analysis_confidence` 仍为加权均值（DeviceIssue、FailureMode、Injury、ClinicalManifestation）。
- Excel 自动确认：建议 `auto_threshold=0.4`、`review_threshold=0.3`（可配置）。

### 4) 结构化确认与图谱写入
- 当 DeviceIssue 有值且 FailureMode缺失：
  - 若一致性分≥T_consistency(0.5)，写入推导出的 FailureMode；否则保留 DeviceIssue 并标注“待确认机制”。
- 图谱关系按你规范：`Report→HAS_FAILUREMODE/HAS_INJURY/HAS_DEVICEISSUE`，`Device→HAS_FAULT→DeviceIssue`，`FailureMode→CAUSES→Injury`。

### 5) 可观测性与维护
- 审计日志：记录 `device_issue_detected`、`failure_mode_derived`、`consistency_score`。
- 统计报表：每日“未知故障模式占比”、“由映射推导出的故障模式数量与确认率”。
- 管理接口：`POST /config/mapping/upload` 支持上传/更新映射文件；`GET /config/mapping/stats` 查看生效情况。

## 修改范围与文件
- `backend/app/services/structure_analyzer.py`：新增一致性推导与二次匹配；合并评分。
- `backend/app/terminology.py`：注入映射候选到 A 类搜索，扩展别名。
- `backend/app/main.py`：审计日志记录一致性；Excel 审核项标注“建议用大模型”。
- `术语库/mappings/device_issue_to_failure_mode.json`：新增维护文件。

## 验证与指标
- 用现有 50 条：统计“未知故障模式”比例下降幅度（目标≥50%下降）。
- 随机抽样 10 条人工复核一致性（正确率≥80%）。
- 观察 `auto_confirmed` 与 `pending` 分布在 `auto_threshold=0.4/0.5` 下的变化。

## 风险与回退
- 若映射误导：保持人工确认优先；低一致性不自动写 FM。
- 配置开关：`ENABLE_ISSUE_FM_MAPPING=true/false`；便于灰度上线。

请确认该改造方案；我将按以上步骤实施，并提供验证报告与审计日志摘要以供你复核。