## 现状概览
- 结构化分析入口：`POST /reports/analyze-structure`（backend/app/main.py:616），规则型抽取由 `StructureAnalyzer` 完成（backend/app/services/structure_analyzer.py:40）。
- 确认入库与图谱写入：`POST /reports/structured-confirm`（backend/app/main.py:643），将匹配术语入内存库并写入 Neo4j（backend/app/graph.py:89）。
- Excel 批量导入：`POST /reports/upload-excel`（backend/app/main.py:950），中英表头映射、日期解析、行级去重。
- 术语匹配与打分：`terminology.search`（backend/app/terminology.py:113），融合基础相似度（backend/app/terminology.py:49）、别名加权（backend/app/terminology.py:138）与 TF‑IDF（backend/app/terminology.py:171）。
- 术语库加载路径：优先 `TERMINOLOGY_DIR`，默认仓库根目录的 `术语库`（backend/app/config.py:6）。
- 知识图谱：实体映射与关系 `CAUSES/MITIGATES/ASSOCIATED_WITH`（backend/app/graph.py:89,134,146,173）；单案图查询（backend/app/graph.py:307）。

## 核心目标
- 基于不良事件报告，完成结构化录入：
  - 基本信息（蓝色）：医院、设备、制造商、型号、批次/序列、发现时间。
  - 事件描述（黄色）：带示例提示与占位符，引导用户撰写。
  - 处置措施（红色）：原文保留，不做术语匹配，仅入库与图谱 `Action` 节点。
- 对事件描述进行结构化分析，与术语库匹配出 4 类术语：设备问题/故障（A）、健康影响（F）、临床症状（E）、病症（E 或扩展分类）。
- 用户确认后入库，并构建图谱节点和关系；保留评分能力但默认不展示，按需显示。
- 增加 LLM（OpenAI/Gemini）兜底：当用户对规则匹配不满意时，触发模型辅助标准化与抽取（现有 `llm_standardize/llm_structure` 可复用）。
- 增强 Excel 批量导入：阈值以上自动确认入库；不足部分进入 "待确认" 队列逐条审核。

## 数据模型与图谱
- 报告主数据：`ReportIn/ReportStored`（backend/app/schemas.py），保留指纹去重与审计日志。
- 图谱实体：`MedicalDevice(Device)`、`Manufacturer`、`Model`、`AdverseEventReport(Report)`、`Fault(FailureMode)`、`Harm(Injury)`、`Measure(Action)`、`ClinicalSymptom`、`Disease`、`EventDate`。
- 关系网络：
  - `Report`→`Device` (`RESULTS_IN`)；`Device`→`Manufacturer` (`MANUFACTURED_BY`)；`Device`→`Model` (`HAS_MODEL`)；`Report`→`EventDate` (`AT_TIME`).
  - `Report`→`FailureMode` (`HAS_FAILUREMODE`)；`Report`→`Injury` (`HAS_INJURY`)；`Report`→`Action` (`HAS_ACTION`).
  - 语义关系：`FailureMode`→`Injury` (`CAUSES`)，`Action`→`FailureMode` (`MITIGATES`)；必要时 `Symptom`→`Disease`（`INDICATES`）。

## 术语匹配流程（规则→兜底）
- 步骤：
  1) 规则抽取：`StructureAnalyzer.analyze_report`（backend/app/services/structure_analyzer.py:40），分项提取：
     - 设备问题：关键词聚类（backend/app/services/structure_analyzer.py:98）。
     - 故障模式：术语库 A 类优先（backend/app/services/structure_analyzer.py:115）。
     - 临床表现：术语库 E 类（backend/app/services/structure_analyzer.py:144）。
     - 健康影响：术语库 F 类或严重度回退（backend/app/services/structure_analyzer.py:171）。
     - 处置措施：文本保留（backend/app/services/structure_analyzer.py:202）。
  2) 标准术语匹配：字段→类别映射（backend/app/services/structure_analyzer.py:211），`top_k=1`、`threshold=0.2` 初筛。
  3) 用户确认：列表显示术语、代码与置信度；默认隐藏评分，点击 "查看评分" 展示。
  4) 不满意→LLM兜底：
     - 标准化选择：`llm_standardize` 从候选中二次判别（backend/app/llm.py:79）。
     - 结构化抽取：`llm_structure` 输出 `entities/relations`（backend/app/llm.py:118）。
  5) 入库与写图：`/reports/structured-confirm`（backend/app/main.py:643）调用 `graph.write_structure`（backend/app/graph.py:89）。

## 批量 Excel 导入
- 上传接口复用（backend/app/main.py:950），新增参数：`auto_threshold`、`review_queue=true/false`、`use_llm_on_low=true/false`。
- 流程：
  - 每行执行规则匹配，评分≥`auto_threshold`（建议 0.60）自动确认；评分介于 `0.30–0.59` 进入待确认；<`0.30` 可选择触发 LLM。
  - 审核页显示待确认列表，逐条确认后批量写图。

## 前端改造（保持简单）
- 表单分区颜色：
  - 蓝色：基本信息区；黄色：事件描述区（含示例提示与引导）；红色：处置措施区。
- 操作按钮：`结构化分析` → `查看评分`（折叠/展开）→ `不满意，用大模型` → `确认入库`。
- Excel 导入页：上传、阈值滑杆、待确认列表、批量确认。
- 隐藏非核心：初始界面不展示评分、不展示风险分析；保留入口在高级页。

## 接口调整与保留
- 保留：`/reports/analyze-structure`、`/reports/structured-confirm`、`/reports/upload-excel`、`/graph/import-terms`、`/graph/status`、`/case/{id}/graph`。
- 新增（不破坏现有）：
  - `POST /reports/analyze-structure?use_llm=true`：直接走兜底分支返回 `entities/relations` 与候选。
  - `POST /reports/upload-excel?auto_threshold=0.6&review_queue=true`：批量导入带自动确认与待审队列。
  - `GET /reports/review-pending`、`POST /reports/review-confirm`：待确认工作流。
- 配置：通过 `TERMINOLOGY_DIR` 指向外部术语库目录 `/Users/fool/githubspace/术语库`；OpenAI/Gemini Key 与模型名通过 `/config/llm` 下发。

## 清理与瘦身
- 隐藏或移除与核心不直接相关的演示/按钮：
  - 首屏移除风险分析按钮与图；将其迁移至高级页面保留功能。
  - 合并 `index.html` 与 `advanced.html` 的重复入口，仅保留核心工作流。
- 代码层面保留评分能力与风险分析模块，但从默认 UI 流程中移除曝光；减少干扰。

## 质量门控与阈值建议
- 术语匹配：`threshold=0.40`（结构化确认前），Excel 自动确认：`auto_threshold=0.60`。
- LLM 调用：仅在用户触发或评分不足时；模型温度 `0.2` 以保证稳定性。
- 去重：指纹规则保持不变；审计日志记录结构化与用户确认（backend/app/main.py:731）。

## 里程碑
- P1：前端分区与按钮改造；默认隐藏评分与风险分析；规则抽取对齐四类术语（含病症）。
- P2：LLM兜底联调（OpenAI/Gemini），候选约束与输出校验。
- P3：Excel 批量导入增强与待确认队列；阈值滑杆与批量确认页。
- P4：图谱节点与关系补全（Symptom/Disease、Action 关系）；单案与总体图验证。
- P5：清理与瘦身（删除冗余入口与演示），文档化配置项与运维参数。
- P6：验收与数据回归（10+ 真实样例），阈值回调与性能检查。

请确认以上改造方向与阈值设定；确认后我将开始实施并逐步验证每一阶段。