<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>æ™ºæ¢°é¢„è­¦ Â· æ¥å…¥æ¼”ç¤º</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto;max-width:980px;margin:20px auto;padding:0 16px}
    h1{font-size:20px;margin:12px 0}
    section{border:1px solid #e5e5e5;border-radius:8px;padding:12px;margin:10px 0}
    label{display:block;margin:6px 0}
    input,textarea,select,button{font-size:14px;padding:6px}
    textarea{width:100%;min-height:90px}
    pre{background:#f7f7f8;padding:10px;overflow:auto;border-radius:6px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
  </style>
</head>
<body>
  <h1>æ™ºæ¢°é¢„è­¦ Â· æ¥å…¥æ¼”ç¤º</h1>

  <section>
    <h2>ğŸ“‹ åŒ»ç–—äº‹ä»¶æŠ¥å‘Šå½•å…¥</h2>
    
    <!-- åŸºæœ¬ä¿¡æ¯éƒ¨åˆ† -->
    <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:15px;">
      <h3 style="margin:0 0 10px 0;color:#2c3e50;">ğŸ¥ åŸºæœ¬ä¿¡æ¯</h3>
      <div class="row">
        <div style="flex:1;min-width:200px;">
          <label style="font-weight:bold;color:#34495e;">ã€åŒ»é™¢ç¼–å·ã€‘</label>
          <input id="hospital_id" placeholder="ä¾‹å¦‚ï¼šH001" value="H001" style="width:100%;">
          <small style="color:#7f8c8d;">åŒ»ç–—æœºæ„å”¯ä¸€æ ‡è¯†</small>
        </div>
        <div style="flex:1;min-width:200px;">
          <label style="font-weight:bold;color:#34495e;">ã€è®¾å¤‡åç§°ã€‘</label>
          <input id="device_name" placeholder="ä¾‹å¦‚ï¼šå¿ƒç”µç›‘æŠ¤ä»ª" value="å¿ƒç”µç›‘æŠ¤ä»ª" style="width:100%;">
          <small style="color:#7f8c8d;">åŒ»ç–—å™¨æ¢°é€šç”¨åç§°</small>
        </div>
        <div style="flex:1;min-width:200px;">
          <label style="font-weight:bold;color:#34495e;">ã€åˆ¶é€ å•†ã€‘</label>
          <input id="manufacturer" placeholder="ä¾‹å¦‚ï¼šé£åˆ©æµ¦åŒ»ç–—" value="ACME" style="width:100%;">
          <small style="color:#7f8c8d;">è®¾å¤‡ç”Ÿäº§å‚å®¶</small>
        </div>
      </div>
      <div class="row" style="margin-top:10px;">
        <div style="flex:1;min-width:200px;">
          <label style="font-weight:bold;color:#34495e;">ã€å‹å·ã€‘</label>
          <input id="model" placeholder="ä¾‹å¦‚ï¼šECG-2000" value="ECG-200" style="width:100%;">
          <small style="color:#7f8c8d;">è®¾å¤‡å…·ä½“å‹å·</small>
        </div>
        <div style="flex:1;min-width:200px;">
          <label style="font-weight:bold;color:#34495e;">ã€æ‰¹æ¬¡/åºåˆ—å·ã€‘</label>
          <input id="lot_sn" placeholder="ä¾‹å¦‚ï¼šL2024001" value="L123" style="width:100%;">
          <small style="color:#7f8c8d;">ç”Ÿäº§æ‰¹æ¬¡æˆ–è®¾å¤‡åºåˆ—å·</small>
        </div>
        <div style="flex:1;min-width:200px;">
          <label style="font-weight:bold;color:#34495e;">ã€äº‹ä»¶å‘ç”Ÿæ—¶é—´ã€‘</label>
          <input id="event_datetime" placeholder="ä¾‹å¦‚ï¼š2024-12-01 10:20" value="2024-12-01T10:20:30Z" style="width:100%;">
          <small style="color:#7f8c8d;">æ ¼å¼ï¼šYYYY-MM-DD HH:mm</small>
        </div>
      </div>
    </div>

    <!-- äº‹ä»¶æè¿°éƒ¨åˆ† -->
    <div style="background:#fff3cd;padding:15px;border-radius:8px;margin-bottom:15px;border-left:4px solid #ffc107;">
      <h3 style="margin:0 0 10px 0;color:#856404;">âš ï¸ äº‹ä»¶æè¿°</h3>
      <label style="font-weight:bold;color:#856404;">ã€æƒ…å†µè¯´æ˜ã€‘è¯·è¯¦ç»†æè¿°è®¾å¤‡ä½¿ç”¨è¿‡ç¨‹ä¸­çš„å¼‚å¸¸æƒ…å†µï¼š</label>
      <textarea id="event_description" placeholder="ä¾‹å¦‚ï¼šè®¾å¤‡ä½¿ç”¨è¿‡ç¨‹ä¸­çªç„¶é»‘å±ï¼Œæ— æ³•ç»§ç»­å¯¹æ‚£è€…ç›‘æŠ¤ï¼Œæœ€åæ›´æ¢æ–°è®¾å¤‡ã€‚" style="width:100%;min-height:120px;">è®¾å¤‡å±å¹•æ— æ˜¾ç¤ºï¼Œæ‚£è€…ç›‘æŠ¤ä¸­æ–­</textarea>
      <small style="color:#856404;">ğŸ’¡ æç¤ºï¼šè¯·åŒ…å«è®¾å¤‡å¼‚å¸¸è¡¨ç°ã€å¯¹æ‚£è€…çš„å½±å“ã€é‡‡å–çš„æªæ–½ç­‰å…³é”®ä¿¡æ¯</small>
    </div>

    <!-- ä¼¤å®³è¯„ä¼°éƒ¨åˆ† -->
    <div style="background:#f8d7da;padding:15px;border-radius:8px;margin-bottom:15px;border-left:4px solid #dc3545;">
      <h3 style="margin:0 0 10px 0;color:#721c24;">ğŸ¥ ä¼¤å®³è¯„ä¼°</h3>
      <div class="row">
        <div style="flex:1;">
          <label style="font-weight:bold;color:#721c24;">ã€ä¼¤å®³ä¸¥é‡ç¨‹åº¦ã€‘</label>
          <select id="injury_severity" style="width:100%;">
            <option value="none">æ— ä¼¤å®³</option>
            <option value="mild">è½»åº¦ä¼¤å®³</option>
            <option value="moderate" selected>ä¸­åº¦ä¼¤å®³</option>
            <option value="severe">é‡åº¦ä¼¤å®³</option>
            <option value="death">æ­»äº¡</option>
          </select>
          <small style="color:#721c24;">è¯„ä¼°äº‹ä»¶å¯¹æ‚£è€…é€ æˆçš„ä¼¤å®³ç¨‹åº¦</small>
        </div>
        <div style="flex:2;">
          <label style="font-weight:bold;color:#721c24;">ã€å¤„ç†æªæ–½ã€‘</label>
          <input id="action_taken" placeholder="ä¾‹å¦‚ï¼šç«‹å³æ›´æ¢è®¾å¤‡ï¼Œå°†æ‚£è€…è½¬å…¥ICUç›‘æŠ¤" value="æ›´æ¢è®¾å¤‡å¹¶åŠ æŠ¤è§‚å¯Ÿ" style="width:100%;">
          <small style="color:#721c24;">æè¿°ä¸ºå‡è½»ä¼¤å®³é‡‡å–çš„åŒ»ç–—æªæ–½</small>
        </div>
      </div>
    </div>

    <!-- æ“ä½œæŒ‰é’® -->
    <div style="text-align:center;margin:20px 0;">
      <button id="btnSubmit" style="background:#6c757d;color:white;padding:10px 20px;border:none;border-radius:5px;margin-right:10px;font-size:16px;">ğŸ“ ç›´æ¥æäº¤</button>
      <button id="btnStandardize" style="background:#007bff;color:white;padding:10px 20px;border:none;border-radius:5px;margin-right:10px;font-size:16px;">ğŸ” æäº¤å¹¶æ ‡å‡†åŒ–</button>
      <button id="btnStructuredAnalysis" style="background:#28a745;color:white;padding:10px 20px;border:none;border-radius:5px;font-size:16px;">ğŸ—ï¸ ç»“æ„åŒ–åˆ†æ</button>
    </div>
    
    <!-- ç»“æ„åŒ–åˆ†æç»“æœå±•ç¤º -->
    <div id="structuredResult" style="display:none;background:#d1ecf1;padding:15px;border-radius:8px;margin-top:15px;border-left:4px solid #17a2b8;">
      <h3 style="margin:0 0 10px 0;color:#0c5460;">ğŸ” ç»“æ„åŒ–åˆ†æç»“æœ</h3>
      <div id="structuredContent"></div>
      <div style="text-align:center;margin-top:15px;">
        <button id="btnConfirmStructure" style="background:#28a745;color:white;padding:8px 16px;border:none;border-radius:5px;margin-right:10px;">âœ… ç¡®è®¤å¹¶å½•å…¥</button>
        <button id="btnRestructure" style="background:#ffc107;color:black;padding:8px 16px;border:none;border-radius:5px;margin-right:10px;">ğŸ”„ LLMé‡æ„</button>
        <button id="btnCancelStructure" style="background:#6c757d;color:white;padding:8px 16px;border:none;border-radius:5px;">âŒ å–æ¶ˆ</button>
      </div>
    </div>
    
    <pre id="outReport"></pre>
</section>

  <section>
    <h2>LLMç»“æ„åŒ–å‰–æ</h2>
    <label>text</label>
    <textarea id="struct_text">è®¾å¤‡å±å¹•æ— æ˜¾ç¤ºï¼Œæ‚£è€…ç›‘æŠ¤ä¸­æ–­</textarea>
    <div class="row">
      <select id="struct_provider">
        <option value="openai">openai</option>
        <option value="gemini">gemini</option>
      </select>
      <button id="btnStruct">ç»“æ„åŒ–å‰–æ</button>
      <input id="struct_report_id" placeholder="report_id (å…¥åº“ç”¨)" style="flex:1">
      <button id="btnStructStore">å‰–æå¹¶å…¥åº“</button>
    </div>
    <pre id="outStruct"></pre>
  </section>

  <section>
    <h2>ç»“æ„åŒ–å½•å…¥æ¼”ç¤º</h2>
    <div class="row">
      <input id="s_hospital_id" placeholder="åŒ»é™¢ç¼–å·" value="H001">
      <input id="s_device_name" placeholder="å™¨æ¢°åç§°" value="å¿ƒç”µç›‘æŠ¤ä»ª">
      <input id="s_manufacturer" placeholder="åˆ¶é€ å•†" value="ACME">
      <input id="s_model" placeholder="å‹å·" value="ECG-200">
      <input id="s_lot_sn" placeholder="æ‰¹æ¬¡æˆ–åºåˆ—å·" value="L123">
    </div>
    <div class="row">
      <input id="s_event_datetime" placeholder="äº‹ä»¶æ—¶é—´" value="2025-01-01T10:20:30Z" style="flex:1">
    </div>
    <label>äº‹ä»¶æè¿°</label>
    <textarea id="s_event_description">ç›‘æŠ¤ä¸­æ–­</textarea>
    <label>æ•…éšœæè¿°ï¼ˆç”¨äºæœ¯è¯­åŒ¹é…Aï¼‰</label>
    <textarea id="s_failure_desc">è®¾å¤‡æ— æ˜¾ç¤º</textarea>
    <label>æŸå®³æè¿°ï¼ˆç”¨äºæœ¯è¯­åŒ¹é…E/Fä¸ä¸¥é‡åº¦åˆ¤å®šï¼‰</label>
    <textarea id="s_injury_desc">æ‚£è€…æ˜è¿·ï¼Œå‘¼å¸å›°éš¾</textarea>
    <label>å¤„ç†æ–¹æ¡ˆæè¿°ï¼ˆç”¨äºæœ¯è¯­åŒ¹é…C/Dï¼‰</label>
    <textarea id="s_action_desc">è½¬å…¥ICUç›‘æŠ¤</textarea>
    <div class="row">
      <button id="btnStructured">ç»“æ„åŒ–å½•å…¥å¹¶åŒ¹é…</button>
    </div>
    <pre id="outStructuredReport"></pre>
  </section>

  <section>
    <h2>å®¡è®¡è¯æ®</h2>
    <pre id="outAudit"></pre>
  </section>

  <section>
    <h2>Excelæ‰¹é‡å¯¼å…¥</h2>
    <div class="row">
      <a href="/templates/reports.xlsx?lang=zh" target="_blank">ä¸‹è½½ä¸­æ–‡æ¨¡æ¿</a>
      <a href="/templates/reports.xlsx?lang=en" target="_blank" style="margin-left:10px">Download English Template</a>
    </div>
    <div class="row" style="margin-top:8px">
      <input type="file" id="excel_file" accept=".xlsx">
      <button id="btnExcel">ä¸Šä¼ Excelå¹¶å¯¼å…¥</button>
    </div>
    <pre id="outExcel"></pre>
  </section>

  <section>
    <h2>æœ¯è¯­å¯¼å…¥åˆ°Neo4j</h2>
    <div class="row">
      <label><input type="checkbox" class="cat" value="A" checked> Aï¼ˆè®¾å¤‡é—®é¢˜ï¼‰</label>
      <label><input type="checkbox" class="cat" value="E" checked> Eï¼ˆä¸´åºŠç—‡çŠ¶/ç—…ç—‡ï¼‰</label>
      <label><input type="checkbox" class="cat" value="F" checked> Fï¼ˆå¥åº·å½±å“ï¼‰</label>
      <label><input type="checkbox" class="cat" value="G"> Gï¼ˆå™¨æ¢°ç»„ä»¶ï¼‰</label>
      <label><input type="checkbox" class="cat" value="C"> Cï¼ˆè°ƒæŸ¥ç»“æœï¼‰</label>
      <label><input type="checkbox" class="cat" value="D"> Dï¼ˆè°ƒæŸ¥ç»“è®ºï¼‰</label>
    </div>
    <div class="row" style="margin-top:8px">
      <label><input type="checkbox" id="include_syn" checked> åŒ…å«åŒä¹‰è¯</label>
      <button id="btnImportTerms">å¯¼å…¥æœ¯è¯­åˆ°Neo4j</button>
    </div>
    <pre id="outImportTerms"></pre>
  </section>

  <section>
    <h2>Dashboard</h2>
    <div id="chart1" style="height:240px"></div>
    <div id="chart2" style="height:240px"></div>
    <pre id="outDash"></pre>
  </section>

  <section>
    <h2>Case View</h2>
    <div class="row">
      <input id="case_id" placeholder="report_id" style="flex:1">
      <button id="btnCase">åŠ è½½å…³ç³»å›¾</button>
    </div>
    <div id="legend" style="margin:8px 0"></div>
    <div id="caseGraph" style="height:360px"></div>
  </section>

  <section>
    <h2>Overview Graph</h2>
    <div class="row">
      <select id="overview_limit">
        <option value="10" selected>10</option>
        <option value="20">20</option>
        <option value="50">50</option>
        <option value="100">100</option>
        <option value="200">200</option>
      </select>
      <button id="btnOverview">åŠ è½½æ€»ä½“å…³ç³»å›¾</button>
      <button id="btnRiskAnalysis">é£é™©ç‚¹åˆ†æ</button>
    </div>
    <div id="overviewGraph" style="height:360px"></div>
    <div id="riskAnalysis" style="margin-top:20px;display:none">
      <h3>é£é™©ç‚¹åˆ†æç»“æœ</h3>
      <pre id="riskResults" style="background:#f7f7f8;padding:10px;border-radius:6px;max-height:200px;overflow:auto"></pre>
    </div>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <script>
    const NODE_COLORS = {
      Report: '#1f77b4',
      Hospital: '#2ca02c',
      Device: '#ff7f0e',
      Manufacturer: '#9467bd',
      Model: '#8c564b',
      EventDate: '#17becf',
      FailureMode: '#d62728',
      Injury: '#e377c2',
      Action: '#7f7f7f',
      StandardTerm: '#bcbd22'
    };
    Object.assign(NODE_COLORS, {
      MedicalDevice: '#ff7f0e',
      AdverseEventReport: '#1f77b4',
      Harm: '#e377c2',
      Fault: '#d62728',
      Measure: '#7f7f7f',
      DiscoveryDate: '#17becf'
    });
    const EDGE_LABEL_CN = {
      RELATED_TO: 'ç›¸å…³äº',
      HAS_FAULT: 'å­˜åœ¨æ•…éšœ',
      RESULTS_IN: 'å¯¼è‡´',
      ADDRESSED_BY: 'ç”±å¤„ç½®æªæ–½å¤„ç†',
      REPORTED_BY: 'ä¸ŠæŠ¥è‡³',
      MANUFACTURED_BY: 'ç”±åˆ¶é€ å•†åˆ¶é€ ',
      HAS_MODEL: 'å‹å·ä¸º',
      AT_TIME: 'å‘ç”Ÿäº',
      CAUSES: 'å¯¼è‡´',
      HAS_FAILUREMODE: 'å…·æœ‰æ•…éšœ',
      HAS_INJURY: 'å…·æœ‰ä¼¤å®³',
      HAS_ACTION: 'å…·æœ‰å¤„ç½®'
    };
    function renderLegend(){
      const entries = Object.entries(NODE_COLORS).map(([k,v])=>`<span style="display:inline-flex;align-items:center;margin-right:10px"><span style="display:inline-block;width:12px;height:12px;background:${v};border-radius:50%;margin-right:6px"></span>${k}</span>`).join('');
      const el = document.getElementById('legend');
      if(el) el.innerHTML = entries;
    }
    renderLegend();
  </script>

  <section>
    <h2>æ–‡æœ¬æ ‡å‡†åŒ–</h2>
    <label>text</label>
    <textarea id="std_text">è®¾å¤‡å±å¹•æ— æ˜¾ç¤ºï¼Œæ‚£è€…ç›‘æŠ¤ä¸­æ–­</textarea>
    <div class="row">
      <button id="btnStd">æ ‡å‡†åŒ–ï¼ˆæœ¬åœ°ï¼‰</button>
      <select id="provider">
        <option value="openai">openai</option>
        <option value="gemini">gemini</option>
      </select>
      <button id="btnLLM">æ ‡å‡†åŒ–ï¼ˆLLMï¼‰</button>
    </div>
    <pre id="outStd"></pre>
  </section>

  <section>
    <h2>LLMé…ç½®</h2>
    <div class="row">
      <select id="cfg_provider">
        <option value="openai">openai</option>
        <option value="gemini">gemini</option>
      </select>
      <input id="cfg_apikey" placeholder="API Key" style="flex:1">
      <input id="cfg_model" placeholder="Model (å¯é€‰)" style="flex:1">
      <button id="btnSaveCfg">ä¿å­˜é…ç½®</button>
    </div>
    <pre id="outCfg"></pre>
  </section>

  <script>
    async function postJSON(url, body){
      const r = await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
      const t = await r.text();
      try{return JSON.parse(t)}catch{return {raw:t}};
    }

    function payload(){
      return {
        hospital_id: document.getElementById('hospital_id').value,
        device_name: document.getElementById('device_name').value,
        manufacturer: document.getElementById('manufacturer').value,
        model: document.getElementById('model').value,
        lot_sn: document.getElementById('lot_sn').value,
        event_datetime: document.getElementById('event_datetime').value,
        event_description: document.getElementById('event_description').value,
        injury_severity: document.getElementById('injury_severity').value,
        action_taken: document.getElementById('action_taken').value,
      }
    }

    document.getElementById('btnSubmit').onclick = async ()=>{
      const data = await postJSON('/reports', payload());
      document.getElementById('outReport').textContent = JSON.stringify(data,null,2);
    }

    document.getElementById('btnStandardize').onclick = async ()=>{
      const params = new URLSearchParams({standardize:'true',categories:'A',categories:'E',categories:'F',categories:'G',top_k:'5'});
      const r = await fetch('/reports?'+params.toString(),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload())});
      document.getElementById('outReport').textContent = await r.text();
    }

    // ç»“æ„åŒ–åˆ†æåŠŸèƒ½
    document.getElementById('btnStructuredAnalysis').onclick = async ()=>{
      const btn = document.getElementById('btnStructuredAnalysis');
      const originalText = btn.textContent;
      btn.textContent = 'ğŸ—ï¸ åˆ†æä¸­...';
      btn.disabled = true;
      
      try {
        // è·å–è¡¨å•æ•°æ®
        const formData = payload();
        
        // è°ƒç”¨ç»“æ„åŒ–åˆ†æAPI
        const response = await fetch('/reports/analyze-structure', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (result.success) {
          // æ˜¾ç¤ºç»“æ„åŒ–ç»“æœ
          displayStructuredResult(result.data);
        } else {
          alert('ç»“æ„åŒ–åˆ†æå¤±è´¥ï¼š' + (result.error || 'æœªçŸ¥é”™è¯¯'));
        }
      } catch (error) {
        alert('åˆ†æè¯·æ±‚å¤±è´¥ï¼š' + error.message);
      } finally {
        btn.textContent = originalText;
        btn.disabled = false;
      }
    }

    // æ˜¾ç¤ºç»“æ„åŒ–åˆ†æç»“æœ
    function displayStructuredResult(data) {
      const resultDiv = document.getElementById('structuredResult');
      const contentDiv = document.getElementById('structuredContent');
      
      let html = `
        <div style="background:white;padding:15px;border-radius:5px;margin-bottom:15px;">
          <h4 style="color:#0c5460;margin:0 0 10px 0;">ğŸ“Š ç»“æ„åŒ–ä¿¡æ¯</h4>
          <table style="width:100%;border-collapse:collapse;">
            <tr><td style="padding:5px;border:1px solid #ddd;background:#f8f9fa;font-weight:bold;">è®¾å¤‡é—®é¢˜ï¼š</td><td style="padding:5px;border:1px solid #ddd;">${data.device_issue || 'æœªè¯†åˆ«'}</td></tr>
            <tr><td style="padding:5px;border:1px solid #ddd;background:#f8f9fa;font-weight:bold;">æ•…éšœæ¨¡å¼ï¼š</td><td style="padding:5px;border:1px solid #ddd;">${data.failure_mode || 'æœªè¯†åˆ«'}</td></tr>
            <tr><td style="padding:5px;border:1px solid #ddd;background:#f8f9fa;font-weight:bold;">ä¸´åºŠè¡¨ç°ï¼š</td><td style="padding:5px;border:1px solid #ddd;">${data.clinical_manifestation || 'æœªè¯†åˆ«'}</td></tr>
            <tr><td style="padding:5px;border:1px solid #ddd;background:#f8f9fa;font-weight:bold;">å¥åº·å½±å“ï¼š</td><td style="padding:5px;border:1px solid #ddd;">${data.health_impact || 'æœªè¯†åˆ«'}</td></tr>
            <tr><td style="padding:5px;border:1px solid #ddd;background:#f8f9fa;font-weight:bold;">å¤„ç½®æªæ–½ï¼š</td><td style="padding:5px;border:1px solid #ddd;">${data.treatment_action || 'æœªè¯†åˆ«'}</td></tr>
          </table>
        </div>
      `;
      
      if (data.matched_terms && data.matched_terms.length > 0) {
        html += `
          <div style="background:white;padding:15px;border-radius:5px;margin-bottom:15px;">
            <h4 style="color:#0c5460;margin:0 0 10px 0;">ğŸ”— åŒ¹é…çš„æ ‡å‡†æœ¯è¯­</h4>
            <ul style="margin:0;padding-left:20px;">
              ${data.matched_terms.map(term => `<li><strong>${term.category}ç±»ï¼š</strong>${term.term} (${term.code}) - ç›¸ä¼¼åº¦ï¼š${(term.similarity * 100).toFixed(1)}%</li>`).join('')}
            </ul>
          </div>
        `;
      }
      
      if (data.analysis_confidence) {
        html += `
          <div style="background:white;padding:15px;border-radius:5px;">
            <h4 style="color:#0c5460;margin:0 0 10px 0;">ğŸ“ˆ åˆ†æç½®ä¿¡åº¦</h4>
            <div style="background:#e9ecef;padding:10px;border-radius:5px;">
              æ•´ä½“ç½®ä¿¡åº¦ï¼š<strong>${(data.analysis_confidence * 100).toFixed(1)}%</strong>
              ${data.confidence_breakdown ? `<br>è¯¦ç»†è¯„åˆ†ï¼š${JSON.stringify(data.confidence_breakdown, null, 2)}` : ''}
            </div>
          </div>
        `;
      }
      
      contentDiv.innerHTML = html;
      resultDiv.style.display = 'block';
      
      // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
      resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    // ç¡®è®¤ç»“æ„åŒ–å½•å…¥
    document.getElementById('btnConfirmStructure').onclick = async ()=>{
      const btn = document.getElementById('btnConfirmStructure');
      const originalText = btn.textContent;
      btn.textContent = 'âœ… å½•å…¥ä¸­...';
      btn.disabled = true;
      
      try {
        // è·å–å½“å‰è¡¨å•æ•°æ®
        const formData = payload();
        
        // è°ƒç”¨ç»“æ„åŒ–å½•å…¥API
        const response = await fetch('/reports/structured-confirm', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('âœ… ç»“æ„åŒ–å½•å…¥æˆåŠŸï¼');
          document.getElementById('structuredResult').style.display = 'none';
          document.getElementById('outReport').textContent = JSON.stringify(result.data, null, 2);
          
          // å¦‚æœæœ‰æŠ¥å‘ŠIDï¼Œè‡ªåŠ¨åŠ è½½æ¡ˆä¾‹è§†å›¾
          if (result.data && result.data.report_id) {
            document.getElementById('case_id').value = result.data.report_id;
            document.getElementById('btnCase').click();
          }
        } else {
          alert('å½•å…¥å¤±è´¥ï¼š' + (result.error || 'æœªçŸ¥é”™è¯¯'));
        }
      } catch (error) {
        alert('å½•å…¥è¯·æ±‚å¤±è´¥ï¼š' + error.message);
      } finally {
        btn.textContent = originalText;
        btn.disabled = false;
      }
    }

    // LLMé‡æ„åŠŸèƒ½
    document.getElementById('btnRestructure').onclick = async ()=>{
      const btn = document.getElementById('btnRestructure');
      const originalText = btn.textContent;
      btn.textContent = 'ğŸ”„ é‡æ„ä¸­...';
      btn.disabled = true;
      
      try {
        // è·å–è¡¨å•æ•°æ®
        const formData = payload();
        
        // è°ƒç”¨LLMé‡æ„API
        const response = await fetch('/llm/restructure', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            ...formData,
            provider: 'openai' // é»˜è®¤ä½¿ç”¨OpenAIï¼Œå¯ä»¥æ ¹æ®éœ€è¦ä¿®æ”¹
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          // æ›´æ–°è¡¨å•æ•°æ®
          if (result.data.device_name) document.getElementById('device_name').value = result.data.device_name;
          if (result.data.event_description) document.getElementById('event_description').value = result.data.event_description;
          if (result.data.action_taken) document.getElementById('action_taken').value = result.data.action_taken;
          
          // é‡æ–°è¿›è¡Œç»“æ„åŒ–åˆ†æ
          document.getElementById('btnStructuredAnalysis').click();
        } else {
          alert('LLMé‡æ„å¤±è´¥ï¼š' + (result.error || 'æœªçŸ¥é”™è¯¯'));
        }
      } catch (error) {
        alert('é‡æ„è¯·æ±‚å¤±è´¥ï¼š' + error.message);
      } finally {
        btn.textContent = originalText;
        btn.disabled = false;
      }
    }

    // å–æ¶ˆç»“æ„åŒ–åˆ†æ
    document.getElementById('btnCancelStructure').onclick = ()=>{
      document.getElementById('structuredResult').style.display = 'none';
    }

    document.getElementById('btnStructured').onclick = async ()=>{
      const body = {
        hospital_id: document.getElementById('s_hospital_id').value,
        device_name: document.getElementById('s_device_name').value,
        manufacturer: document.getElementById('s_manufacturer').value,
        model: document.getElementById('s_model').value,
        lot_sn: document.getElementById('s_lot_sn').value,
        event_datetime: document.getElementById('s_event_datetime').value,
        event_description: document.getElementById('s_event_description').value,
        failure_desc: document.getElementById('s_failure_desc').value,
        injury_desc: document.getElementById('s_injury_desc').value,
        action_desc: document.getElementById('s_action_desc').value,
      };
      const res = await postJSON('/reports/structured', body);
      document.getElementById('outStructuredReport').textContent = JSON.stringify(res,null,2);
      const rid = res && res.report && res.report.report_id;
      if(rid){
        document.getElementById('case_id').value = rid;
        // æ‹‰å–å®¡è®¡è¯æ®
        try{
          const a = await fetch('/reports/'+rid+'/audit');
          const logs = await a.json();
          const sev = logs.filter(l=>l.event==='severity_evidence');
          if(sev.length){
            const latest = sev[sev.length-1];
            let detail = {};
            try{ detail = JSON.parse(latest.detail); }catch{}
            const levelMap = {death:'æ­»äº¡', severe:'é‡åº¦', moderate:'ä¸­åº¦', mild:'è½»åº¦', none:'æ— '};
            const levelCN = levelMap[detail.level] || detail.level || 'æœªçŸ¥';
            const kws = (detail.evidence||[]).map(x=>x.keyword).join('ã€');
            const sentence = `ä¸¥é‡åº¦=${levelCN}ï¼ˆ${detail.level}ï¼‰ã€‚ä¾æ®ï¼šå‘½ä¸­å…³é”®è¯ï¼š${kws}`;
            document.getElementById('outAudit').textContent = sentence;
          }else{
            document.getElementById('outAudit').textContent = JSON.stringify(logs,null,2);
          }
        }catch(e){
          document.getElementById('outAudit').textContent = 'å®¡è®¡åŠ è½½å¤±è´¥';
        }
        // åŠ è½½Case View
        document.getElementById('btnCase').click();
      }
    }

    document.getElementById('btnExcel').onclick = async ()=>{
      const f = document.getElementById('excel_file').files[0];
      if(!f){ document.getElementById('outExcel').textContent = 'è¯·é€‰æ‹©Excelæ–‡ä»¶'; return; }
      const fd = new FormData();
      fd.append('file', f);
      const r = await fetch('/reports/upload-excel',{method:'POST', body:fd});
      const t = await r.text();
      try{ document.getElementById('outExcel').textContent = JSON.stringify(JSON.parse(t),null,2); }
      catch{ document.getElementById('outExcel').textContent = t; }
    }

    document.getElementById('btnImportTerms').onclick = async ()=>{
      const cats = Array.from(document.querySelectorAll('.cat')).filter(x=>x.checked).map(x=>x.value);
      const include_synonyms = document.getElementById('include_syn').checked;
      const data = await postJSON('/graph/import-terms', {categories: cats, include_synonyms});
      document.getElementById('outImportTerms').textContent = JSON.stringify(data,null,2);
    }

    document.getElementById('btnStd').onclick = async ()=>{
      const body = {text: document.getElementById('std_text').value, categories:['A','E','F','G'], top_k:5};
      const data = await postJSON('/standardize', body);
      document.getElementById('outStd').textContent = JSON.stringify(data,null,2);
    }

    document.getElementById('btnLLM').onclick = async ()=>{
      const provider = document.getElementById('provider').value;
      const body = {provider, text: document.getElementById('std_text').value, categories:['A','E','F','G'], top_k:5};
      const data = await postJSON('/llm/standardize', body);
      document.getElementById('outStd').textContent = JSON.stringify(data,null,2);
    }

    document.getElementById('btnSaveCfg').onclick = async ()=>{
      const provider = document.getElementById('cfg_provider').value;
      const api_key = document.getElementById('cfg_apikey').value;
      const model = document.getElementById('cfg_model').value;
      const data = await postJSON('/config/llm', {provider, api_key, model});
      document.getElementById('outCfg').textContent = JSON.stringify(data,null,2);
    }

    document.getElementById('btnStruct').onclick = async ()=>{
      const provider = document.getElementById('struct_provider').value;
      const body = {provider, text: document.getElementById('struct_text').value, top_k:5};
      const data = await postJSON('/llm/structure', body);
      document.getElementById('outStruct').textContent = JSON.stringify(data,null,2);
    }

    document.getElementById('btnStructStore').onclick = async ()=>{
      const provider = document.getElementById('struct_provider').value;
      const report_id = document.getElementById('struct_report_id').value;
      const body = {provider, report_id, text: document.getElementById('struct_text').value, top_k:5};
      const data = await postJSON('/llm/structure/store', body);
      document.getElementById('outStruct').textContent = JSON.stringify(data,null,2);
    }

    async function loadDashboard(){
      try{
        const r = await fetch('/dashboard/summary');
        const data = await r.json();
        document.getElementById('outDash').textContent = JSON.stringify(data,null,2);
        const dev = Array.isArray(data.top_devices) ? data.top_devices : [];
        const sev = Array.isArray(data.top_severity) ? data.top_severity : [];
        const c1 = echarts.init(document.getElementById('chart1'));
        c1.setOption({tooltip:{},xAxis:{type:'category',data:dev.map(x=>x[0])},yAxis:{type:'value'},series:[{type:'bar',data:dev.map(x=>x[1])}]});
        const c2 = echarts.init(document.getElementById('chart2'));
        c2.setOption({tooltip:{},xAxis:{type:'category',data:sev.map(x=>x[0])},yAxis:{type:'value'},series:[{type:'bar',data:sev.map(x=>x[1])}]});
      }catch(e){
        document.getElementById('outDash').textContent = 'åŠ è½½å¤±è´¥';
      }
    }
    loadDashboard();

    document.getElementById('btnCase').onclick = async ()=>{
      const id = document.getElementById('case_id').value.trim();
      if(!id) return;
      const r = await fetch('/case/'+id+'/graph');
      const data = await r.json();
      const g = echarts.init(document.getElementById('caseGraph'));
      g.setOption({
        tooltip:{formatter:(p)=>{
          if(p.dataType==='edge'){
            const en = p.name || '';
            return EDGE_LABEL_CN[en] || en;
          }
          return (p.data && p.data.name) ? p.data.name : '';
        }},
        series:[{
          type:'graph',
          layout:'force',
          roam:true,
          label:{show:false},
          emphasis:{label:{show:true}},
          data:data.nodes.map(n=>({id:n.id,name:n.name,category:n.label,itemStyle:{color: (NODE_COLORS[n.label]||'#888')},code:n.code,hierarchy:n.hierarchy,definition:n.definition,st_category:n.category})),
          links:data.edges.map(e=>({source:e.source,target:e.target,name:e.label})),
          force:{repulsion:160}
        }]
      });
      g.on('click',(p)=>{
        const d = p.data || {};
        const info = {
          id: d.id,
          name: d.name,
          type: d.category,
          code: d.code,
          hierarchy: d.hierarchy,
          definition: d.definition,
          category: d.st_category
        };
        const lines = Object.entries(info).filter(([k,v])=>v).map(([k,v])=>`${k}: ${v}`);
        const el = document.getElementById('outCaseDetails');
        if(el) el.textContent = lines.join('\n');
      });
    }

    document.getElementById('btnOverview').onclick = async ()=>{
      const limit = document.getElementById('overview_limit').value;
      const r = await fetch('/case/recent-graph?limit='+limit);
      const data = await r.json();
      const g = echarts.init(document.getElementById('overviewGraph'));
      g.setOption({
        tooltip:{formatter:(p)=>{
          if(p.dataType==='edge'){
            const en = p.name || '';
            return EDGE_LABEL_CN[en] || en;
          }
          return (p.data && p.data.name) ? p.data.name : '';
        }},
        series:[{
          type:'graph',
          layout:'force',
          roam:true,
          label:{show:false},
          emphasis:{label:{show:true}},
          data:data.nodes.map(n=>({id:n.id,name:n.name,category:n.label,itemStyle:{color:(NODE_COLORS[n.label]||'#888')}})),
          links:data.edges.map(e=>({source:e.source,target:e.target,name:e.label})),
          force:{repulsion:140}
        }]
      });
    }

    document.getElementById('btnRiskAnalysis').onclick = async ()=>{
      const limit = document.getElementById('overview_limit').value;
      const btn = document.getElementById('btnRiskAnalysis');
      const originalText = btn.textContent;
      btn.textContent = 'åˆ†æä¸­...';
      btn.disabled = true;
      
      try {
        const r = await fetch('/graph/risk-analysis', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({limit: parseInt(limit)})
        });
        const result = await r.json();
        
        if (result.success && result.data) {
          const riskData = result.data;
          let output = `é£é™©åˆ†æç»“æœï¼ˆåŸºäºæœ€è¿‘${limit}ä¸ªæ¡ˆä¾‹ï¼‰ï¼š\n`;
          output += `æ€»é£é™©ç‚¹ï¼š${riskData.total_risks} ä¸ª\n`;
          output += `é«˜é£é™©ï¼š${riskData.high_risks} ä¸ªï¼Œä¸­é£é™©ï¼š${riskData.medium_risks} ä¸ªï¼Œä½é£é™©ï¼š${riskData.low_risks} ä¸ª\n\n`;
          
          if (riskData.risk_details && riskData.risk_details.length > 0) {
            output += "ä¸»è¦é£é™©ç‚¹è¯¦æƒ…ï¼š\n";
            output += "=".repeat(50) + "\n";
            
            riskData.risk_details.forEach((risk, index) => {
              const riskLevelCN = risk.risk_level === 'high' ? 'é«˜é£é™©' : 
                                risk.risk_level === 'medium' ? 'ä¸­é£é™©' : 'ä½é£é™©';
              output += `${index + 1}. ã€${riskLevelCN}ã€‘${risk.description}\n`;
              output += `   é£é™©è¯„åˆ†ï¼š${risk.risk_score?.toFixed(2) || 'N/A'}\n`;
              
              // æ˜¾ç¤ºè¯æ®
              if (risk.evidence) {
                output += "   è¯æ®ï¼š";
                if (risk.evidence.device_name) {
                  output += `è®¾å¤‡ï¼š${risk.evidence.device_name}ï¼Œ`;
                }
                if (risk.evidence.event_count) {
                  output += `äº‹ä»¶æ•°ï¼š${risk.evidence.event_count}ï¼Œ`;
                }
                if (risk.evidence.occurrence_count) {
                  output += `å‡ºç°æ¬¡æ•°ï¼š${risk.evidence.occurrence_count}ï¼Œ`;
                }
                if (risk.evidence.correlation_frequency) {
                  output += `å…³è”é¢‘ç‡ï¼š${risk.evidence.correlation_frequency}ï¼Œ`;
                }
                output = output.replace(/ï¼Œ$/, '') + "\n";
              }
              
              // æ˜¾ç¤ºå»ºè®®
              if (risk.recommendation) {
                output += `   å»ºè®®ï¼š${risk.recommendation}\n`;
              }
              output += "-".repeat(40) + "\n";
            });
          } else {
            output += "æœªæ£€æµ‹åˆ°æ˜æ˜¾é£é™©ç‚¹ï¼Œç³»ç»Ÿè¿è¡Œæ­£å¸¸ã€‚";
          }
          
          document.getElementById('riskResults').textContent = output;
          document.getElementById('riskAnalysis').style.display = 'block';
        } else {
          document.getElementById('riskResults').textContent = 'é£é™©åˆ†æå¤±è´¥ï¼š' + (result.error || 'æœªçŸ¥é”™è¯¯');
          document.getElementById('riskAnalysis').style.display = 'block';
        }
      } catch (error) {
        document.getElementById('riskResults').textContent = 'åˆ†æè¯·æ±‚å¤±è´¥ï¼š' + error.message;
        document.getElementById('riskAnalysis').style.display = 'block';
      } finally {
        btn.textContent = originalText;
        btn.disabled = false;
      }
    }
  </script>
  <section>
    <h2>èŠ‚ç‚¹è¯¦æƒ…</h2>
    <pre id="outCaseDetails"></pre>
  </section>
</body>
</html>