# 系统模块与接口总览

## 模块结构
- 后端应用：`backend/app/main.py`
  - FastAPI 应用初始化、静态资源挂载 `/ui`、所有路由定义
- 数据模型：`backend/app/schemas.py`
  - `ReportIn/ReportOut/ReportStored/ProcessingLog`
- 持久化存储：`backend/app/db.py`
  - 关系型数据库持久化（默认 `SQLite`，环境变量 `DB_URL` 可切换）
  - 提供 `get_db()/init_db()` 供应用使用
- 存储适配：`backend/app/storage.py`
  - `upsert_report/by_id/find_by_fingerprint/now`
- 术语与匹配：`backend/app/terminology.py`（搜索与类别枚举）
- LLM 集成：`backend/app/llm.py`
  - OpenAI/Gemini/SiliconFlow 客户端与调用
  - 标准化与结构化分析提示构建与解析
  - 代码参考：`backend/app/llm.py:36-64` `_build_prompt`、`backend/app/llm.py:79-126` `llm_standardize`、`backend/app/llm.py:128-171` `llm_structure`、`backend/app/llm.py:195-213` `_parse_json_strict`
- 图谱与 Neo4j：`backend/app/graph.py`
  - 报告、实体、关系写入与查询，标准术语导入
- 业务服务：
  - 脱敏：`backend/app/services/deidentify.py`
  - 清洗/指纹：`backend/app/services/cleaning.py`
  - 严重度：`backend/app/services/severity.py`
  - 结构分析：`backend/app/services/structure_analyzer.py`
  - 风险分析：`backend/app/services/risk_analysis.py`
- 审计日志：`backend/app/audit.py`
- 静态资源：`backend/static`（通过 `/ui` 挂载）

## 配置项
- LLM
  - `OPENAI_API_KEY`、`OPENAI_MODEL`
  - `GEMINI_API_KEY`、`GEMINI_MODEL`
  - `SILICONFLOW_API_KEY`、`SILICONFLOW_MODEL`
- 数据库
  - `DB_URL`（默认 `sqlite:///./data.db`）
- Neo4j
  - `NEO4J_URI`、`NEO4J_USER`、`NEO4J_PASS`
  - `NEO4J_MAP_STANDARD_TERMS`

## 接口总览（方法 路径 → 说明）
- POST `/reports` → 创建并处理报告（指纹去重、脱敏、严重度补齐，写入 Neo4j）
- GET `/reports/{report_id}` → 获取报告详情
- GET `/reports/{report_id}/audit` → 获取报告审计日志
- POST `/standardize` → 术语检索（按类别与阈值，返回候选列表）
- POST `/classify/severity` → 文本严重度分类（附证据）
- POST `/analyze/failure` → 结合术语与严重度的故障分析
- POST `/reports/structured` → 基于输入字段与描述，生成结构化匹配并写入图谱
- GET `/reports/{report_id}/standardized` → 指定报告的术语检索视图
- POST `/llm/standardize` → LLM 标准化选择（候选受限，`results{Category:[code,term,score]}`）
- POST `/llm/structure` → LLM 结构化抽取（`entities/relations`），支持 `categories` 与 `echo_prompt`
- POST `/llm/structure/store` → LLM 结构化并写入图谱
- POST `/config/llm` → 设置 LLM 提供商与模型（支持 `openai|gemini|siliconflow`）
- POST `/config/neo4j` → 设置 Neo4j 连接信息
- GET `/dashboard/summary` → 仪表盘概览（Top设备、Top严重度、最近报告）
- GET `/case/{report_id}/graph` → 单案例图谱（含回退构建视图）
- GET `/case/recent-graph` → 最近案例的知识图谱概览
- POST `/reports/analyze-structure` → 结构化分析（可附加 LLM 抽取增强）
- POST `/reports/structured-confirm` → 确认结构化并入库与图谱写入
- POST `/llm/restructure` → LLM 重构报告描述（说明性提示，返回优化后的字段）
- POST `/graph/risk-analysis` → 基于图数据的风险点分析
- POST `/tags/update-hints` → 更新触发标签提示
- POST `/tags/update-term` → 为术语更新标签
- POST `/feedback/llm-improve` → 根据实体反馈更新触发词/标签
- GET `/evaluate/terms` → 术语检索评估（命中率与 MRR）
- POST `/graph/import-terms` → 导入标准术语到 Neo4j（含别名）
- GET `/graph/term/{code}/neighbors` → 查询术语邻居（父/子/别名）
- GET `/graph/status` → Neo4j 状态
- GET `/reports/review-pending` → 审核队列列表
- POST `/reports/review-confirm` → 审核确认与入库并图谱写入
- POST `/reports/upload-excel` → 批量导入 Excel（含自动确认与审核队列）
- GET `/templates/reports.xlsx` → 下载模板（中/英）
- POST `/admin/db/clear` → 清空应用数据库
- POST `/reports/import-json` → 批量导入 JSON 数据
- POST `/config/neo4j-mapping` → 设置图谱映射标准术语开关
- POST `/admin/neo4j/clear` → 清空 Neo4j 所有节点与关系

## LLM 输入输出规范
- 标准化：`llm_standardize(provider, text, categories, top_k)`
  - 输入：`instruction/text/top_k/candidates/output_schema`
  - 输出：`{"results": {Category: [{code, term, score}]}}`
- 结构化：`llm_structure(provider, text, top_k, echo_prompt, categories)`
  - 输入：`instruction/text/candidates/output_schema`（可 `echo_prompt` 回显）
  - 输出：`{"entities": [...], "relations": [...]}`
- 解析兜底：`backend/app/llm.py:195-213` `_parse_json_strict`（代码块剥离/子串提取）

## 数据与图谱
- 持久化库
  - 默认 `SQLite` 文件 `./data.db`，重启不丢数据
  - 可通过 `DB_URL` 切换到 PostgreSQL 等
- 图数据库（Neo4j）
  - 保存报告节点与医疗实体、关系（`CAUSES/MAPS_TO/HAS_*`），用于关系分析与图可视化
  - 写入：`backend/app/graph.py:40-76` 报告，`backend/app/graph.py:78-118` 结构化实体/关系

## 静态资源与UI
- `backend/app/main.py:28-29` 将 `backend/static` 挂载为 `/ui`，用于前端预览

## 验证建议
- 健康状态：访问 `GET /graph/status` 与 `GET /dashboard/summary`
- LLM配置：通过 `POST /config/llm` 设置密钥与模型后再调用 `/llm/*` 接口
- 导入后重启：数据保持在 `SQLite`，图数据在 Neo4j，二者互补